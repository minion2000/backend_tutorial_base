openapi: 3.1.0
info:
  version: 1.0.0
  title: Comment API
  description: |
    記事に対するコメント機能のAPI

    ## 概要
    ユーザーが記事に対してコメントを投稿・閲覧・編集・削除できるシステムです。

    ## 認証
    コメントの作成・更新・削除には Bearer トークンによる認証が必要です。
servers:
  - url: http://localhost/api/v1
    description: ローカル環境

tags:
  - name: Comments
    description: コメント関連のAPI

paths:
  /articles/{articleId}/comments:
    get:
      tags:
        - Comments
      summary: コメント一覧取得
      description: |
        指定された記事に紐づくコメントを新しい順で取得します。
        削除済みのコメントは除外されます。
        認証は不要です。
      operationId: getComments
      parameters:
        - name: articleId
          in: path
          description: 記事ID
          required: true
          schema:
            type: integer
            format: int64
        - name: page
          in: query
          description: ページ番号
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: per_page
          in: query
          description: 1ページあたりの件数
          schema:
            type: integer
            minimum: 1
            maximum: 50
            default: 20
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Comment'
                  pagination:
                    $ref: '#/components/schemas/Pagination'
              example:
                data:
                  - id: 456
                    article_id: 45
                    user:
                      id: 9
                      display_name: "TestTaro"
                      avatar_url: null
                    content: "テストテスト"
                    created_at: "2025-09-20T03:20:00+09:00"
                    updated_at: "2025-09-20T03:25:10+09:00"
                    is_owner: false
                pagination:
                  page: 1
                  per_page: 20
                  total: 128
        '404':
          description: 記事が見つかりません
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '422':
          description: バリデーションエラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'

    post:
      tags:
        - Comments
      summary: コメント作成
      description: |
        指定された記事に新しいコメントを作成します。
        認証が必要です。
      operationId: createComment
      parameters:
        - name: articleId
          in: path
          description: 記事ID
          required: true
          schema:
            type: integer
            format: int64
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - content
              properties:
                content:
                  type: string
                  minLength: 10
                  maxLength: 100
                  description: コメント本文（10〜100文字）
            example:
              content: "テストテスト初回"
      responses:
        '201':
          description: 作成成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/Comment'
              example:
                data:
                  id: 789
                  article_id: 45
                  user:
                    id: 9
                    display_name: "TestTaro"
                    avatar_url: null
                  content: "テストテスト初回"
                  created_at: "2025-09-20T03:20:00+09:00"
                  updated_at: "2025-09-20T03:20:00+09:00"
                  is_owner: true
        '401':
          description: 認証エラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: 記事が見つかりません
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '422':
          description: バリデーションエラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'

  /comments/{commentId}:
    put:
      tags:
        - Comments
      summary: コメント更新
      description: |
        自分が投稿したコメントを更新します。
        他人のコメントは更新できません。
        認証が必要です。
      operationId: updateComment
      parameters:
        - name: commentId
          in: path
          description: コメントID
          required: true
          schema:
            type: integer
            format: int64
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - content
              properties:
                content:
                  type: string
                  minLength: 10
                  maxLength: 100
                  description: コメント本文（10〜100文字）
            example:
              content: "テストテスト修正"
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/Comment'
              example:
                data:
                  id: 789
                  article_id: 45
                  user:
                    id: 9
                    display_name: "TestTaro"
                    avatar_url: null
                  content: "テストテスト修正"
                  created_at: "2025-09-23T03:20:00+09:00"
                  updated_at: "2025-09-23T03:25:10+09:00"
                  is_owner: true
        '401':
          description: 認証エラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: コメントが見つかりません（または所有者ではありません）
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '422':
          description: バリデーションエラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'

    delete:
      tags:
        - Comments
      summary: コメント削除
      description: |
        自分が投稿したコメントを論理削除します。
        他人のコメントは削除できません。
        認証が必要です。
      operationId: deleteComment
      parameters:
        - name: commentId
          in: path
          description: コメントID
          required: true
          schema:
            type: integer
            format: int64
      security:
        - bearerAuth: []
      responses:
        '204':
          description: 削除成功（レスポンスボディなし）
        '401':
          description: 認証エラー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: コメントが見つかりません（または所有者ではありません）
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        Laravel Sanctum のトークンを使用します。
        ヘッダー形式: `Authorization: Bearer {token}`

  schemas:
    Comment:
      type: object
      properties:
        id:
          type: integer
          format: int64
          description: コメントID
          example: 456
        article_id:
          type: integer
          format: int64
          description: 記事ID
          example: 45
        user:
          type: object
          properties:
            id:
              type: integer
              format: int64
              description: ユーザーID
              example: 9
            display_name:
              type: string
              description: 表示名
              example: "TestTaro"
            avatar_url:
              type: string
              nullable: true
              description: アバターURL
              example: null
        content:
          type: string
          minLength: 10
          maxLength: 100
          description: コメント本文
          example: "テストテスト"
        created_at:
          type: string
          format: date-time
          description: 作成日時
          example: "2025-09-20T03:20:00+09:00"
        updated_at:
          type: string
          format: date-time
          description: 更新日時
          example: "2025-09-20T03:25:10+09:00"
        is_owner:
          type: boolean
          description: リクエストユーザーがコメントの所有者かどうか
          example: false

    Pagination:
      type: object
      properties:
        page:
          type: integer
          description: 現在のページ番号
          example: 1
        per_page:
          type: integer
          description: 1ページあたりの件数
          example: 20
        total:
          type: integer
          description: 総件数
          example: 128

    Error:
      type: object
      properties:
        message:
          type: string
          description: エラーメッセージ
          example: "Unauthenticated."

    ValidationError:
      type: object
      properties:
        message:
          type: string
          description: エラーメッセージ
          example: "The content field is required."
        errors:
          type: object
          description: フィールドごとのエラー詳細
          additionalProperties:
            type: array
            items:
              type: string
          example:
            content:
              - "The content field is required."
              - "The content must be at least 10 characters."
